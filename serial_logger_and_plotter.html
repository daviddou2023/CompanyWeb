<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Serial Logger and Plotter</title>
    <!-- 引入Chart.js库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  </head>
  <body>
    <!-- 创建一个画布用于绘制图表 -->
    <canvas id="myChart" height="100"></canvas>
    <!-- 创建连接和结束按钮 -->
    <div>
      <button id="butConnect">connect</button><span style="padding: 1%"></span>
      <button id="butEnd">end</button>
    </div>
    <!-- 显示接收数据的区域 -->
    <div style="margin: 10px">Received:</div>
    <div id="received-data-list" style="border: groove; margin: 10px"></div>
    <script>
      /*** 查找图表和列表标签 ***/
      var ctx = document.getElementById("myChart").getContext("2d");
      var chart = new Chart(ctx, {
        // 要创建的图表类型
        type: "line",

        // 数据集
        data: {
          labels: [],
          datasets: [
            {
              label: "Heart Rate",
              borderColor: "rgb(255, 99, 132)",
              data: [],
              fill: false,
            },
            {
              label: "Blood Oxygen",
              borderColor: "blue",
              data: [],
              fill: false,
            },
          ],
        },
        // 配置选项
        options: {
          title: {
            display: true,
            text: new Date().toLocaleDateString(),
          },
        },
      });

      // 获取显示数据的元素
      const dataList = document.getElementById("received-data-list");
      /*** 查找图表和列表标签结束 ***/

      /*** butConnect 按钮监听器 ***/
      let keepReading = true;
      let reader;
      let writer;
      // 存储所有接收到的数据帧
      let receivedframe = [];

      document
        .getElementById("butConnect")
        .addEventListener("click", async () => {
          // 请求访问串口
          const port = await navigator.serial.requestPort();
          // 以9600波特率打开串口
          await port.open({ baudRate: 9600 });
          keepReading = true;
          reader = port.readable.getReader();
          writer = port.writable.getWriter();

          // 设置定期写入设备的命令
          const writeInt = setInterval(async () => {
            const commandframe = new Uint8Array([
              0x00,
              0xff,
              /*...一些待发送的字节*/
            ]);
            await writer.write(commandframe);
          }, 3000); // 每3000毫秒发送一次命令帧

          while (port.readable && keepReading) {
            try {
              while (true) {
                const { value, done } = await reader.read();
                if (done) {
                  // 允许稍后关闭串口
                  reader.releaseLock();
                  writer.releaseLock();
                  break;
                }
                if (value) {
                  /*** 处理接收到的数据 ***/
                  dealWithData(value);
                }
              }
            } catch (error) {
              // 处理非致命的读取错误
              console.error(error);
            } finally {
              console.log(port.readable, keepReading);
            }
          }
          clearInterval(writeInt);
          await port.close();
          console.log("port closed");
        });
      /*** butConnect 按钮监听器结束 ***/

      /*** 处理数据的函数 ***/
      function dealWithData(value) {
        // 将Uint8Array类型的数据转换为字符串并按逗号分割
        let dataStr = new TextDecoder().decode(value).trim();
        let [heartRate, bloodOxygen] = dataStr.split(',').map(Number);

        if (!isNaN(heartRate) && !isNaN(bloodOxygen)) {
          let datatime = new Date();
          let frame = {
            datatime,
            heartRate,
            bloodOxygen,
          };

          // 记录数据帧
          receivedframe.push(frame);

          // 在页面上显示数据
          dataList.innerHTML += `<p>[${datatime.toLocaleString()}] -> Heart Rate: ${heartRate}, Blood Oxygen: ${bloodOxygen}</p>`;

          // 更新图表
          chart.data.labels.push(datatime.toLocaleTimeString());
          chart.data.datasets[0].data.push(heartRate);
          chart.data.datasets[1].data.push(bloodOxygen);
          chart.update();
        }
      }
      /*** 处理数据的函数结束 ***/

      /*** butEnd 按钮监听器 ***/
      document.getElementById("butEnd").addEventListener("click", async () => {
        keepReading = false;
        reader.cancel();
        // 创建一个新的文件句柄
        const jsonHandle = await window.showSaveFilePicker();
        // 创建一个可写入的文件流
        const writableStream = await jsonHandle.createWritable();
        // 写入文件
        const aBlob = new Blob([JSON.stringify(receivedframe)], {
          type: "text/plain",
        });
        await writableStream.write(aBlob);
        receivedframe = [];
        // 关闭文件并将内容写入磁盘
        await writableStream.close();
      });
      /*** butEnd 按钮监听器结束 ***/
    </script>
  </body>
</html>
