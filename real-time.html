<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>实时监测</title>
  <link href="css/style.css" rel="stylesheet" type="text/css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  <script src="JS/time.js"></script>
</head>
<body>
  <nav>
    <ul>
      <li><a href="index.html">主页</a></li>
      <li><a href="application-scenarios.html">应用场景</a></li>
      <li><a href="workers-information.html">工人信息</a></li>
      <li><a href="real-time.html">实时监测</a></li>
      <li><a href="contact-us.html">联系我们</a></li>
      <li><a href="login.html">登录</a></li>
      <li id="time-container"><span id="current-time"></span></li>
    </ul>
  </nav>
  <img src="images/index-main.jpg" alt="" width="100%">
  <div class="box">
    <div class="title">
      <img src="images/thumbnail.webp" alt="">
      <h1>实时监测</h1>
      <img src="images/thumbnail.webp" alt="">
    </div>
  </div>

  <canvas id="myChart" height="300"></canvas>
  <div>
    <button id="butConnect">连接</button>
    <span style="padding: 1%"></span>
    <button id="butEnd">结束</button>
  </div>
  <div style="margin: 10px">接收到的数据:</div>
  <div id="received-data-list" style="border: groove; margin: 10px"></div>

  <footer>
    <table>
      <tr>
        <td><h3>友情链接</h3></td>
      </tr>
      <tr>
        <td><a href="https://www.redcross.org.cn/">中国红十字会</a></td>
      </tr>
    </table>
    <p id="copy">&copy;版权所有：爱心慈善 地址: XX市XX区XXXX街XX号 邮编: 100000</p>
  </footer>

  <script>
    var ctx = document.getElementById("myChart").getContext("2d");
    var chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "心率",
            borderColor: "rgb(255, 99, 132)",
            data: [],
            fill: false,
          },
          {
            label: "血氧",
            borderColor: "blue",
            data: [],
            fill: false,
          },
        ],
      },
      options: {
        title: {
          display: true,
          text: new Date().toLocaleDateString(),
        },
      },
    });

    const dataList = document.getElementById("received-data-list");

    let keepReading = true;
    let reader;
    let writer;
    let receivedframe = [];

    document.getElementById("butConnect").addEventListener("click", async () => {
      const port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });
      keepReading = true;
      reader = port.readable.getReader();
      writer = port.writable.getWriter();

      const writeInt = setInterval(async () => {
        const commandframe = new Uint8Array([
          0x00,
          0xff,
          /*...一些需要发送的字节*/
        ]);
        await writer.write(commandframe);
      }, 3000);

      while (port.readable && keepReading) {
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) {
              reader.releaseLock();
              writer.releaseLock();
              break;
            }
            if (value) {
              dealWithData(value);
            }
          }
        } catch (error) {
          console.error(error);
        } finally {
          console.log(port.readable, keepReading);
        }
      }
      clearInterval(writeInt);
      await port.close();
      console.log("端口已关闭");
    });

    function dealWithData(value) {
      let dataStr = new TextDecoder().decode(value).trim();
      let [heartRateStr, bloodOxygenStr] = dataStr.split(',').map(item => item.trim());
      let heartRate = parseInt(heartRateStr);
      let bloodOxygen = parseInt(bloodOxygenStr);

      if (!isNaN(heartRate) && !isNaN(bloodOxygen)) {
        let datatime = new Date();
        let frame = {
          datatime,
          heartRate,
          bloodOxygen,
        };

        receivedframe.push(frame);

        dataList.innerHTML += `<p>[${datatime.toLocaleString()}] -> 心率: ${heartRate}, 血氧: ${bloodOxygen}</p>`;

        chart.data.labels.push(datatime.toLocaleTimeString());
        chart.data.datasets[0].data.push(heartRate);
        chart.data.datasets[1].data.push(bloodOxygen);
        chart.update();
      }
    }

    document.getElementById("butEnd").addEventListener("click", async () => {
      keepReading = false;
      reader.cancel();
      const jsonHandle = await window.showSaveFilePicker();
      const writableStream = await jsonHandle.createWritable();
      const aBlob = new Blob([JSON.stringify(receivedframe)], { type: "text/plain" });
      await writableStream.write(aBlob);
      receivedframe = [];
      await writableStream.close();
    });
  </script>
</body>
</html>
